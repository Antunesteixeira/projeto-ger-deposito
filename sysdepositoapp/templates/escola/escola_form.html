{% extends '_layout/base.html' %}

{% block title %}{{ titulo }} - SysDep√≥sito{% endblock %}

{% block content %}
<div style="max-width: 1200px; margin: 0 auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h2>{{ titulo }}</h2>
        <a href="{% url 'escola:lista_escolas' %}" class="btn" style="background: #6c757d;">‚Üê Voltar para Lista</a>
    </div>

    <!-- Mensagens -->
    {% if messages %}
    <div style="margin-bottom: 1.5rem;">
        {% for message in messages %}
        <div style="padding: 1rem; border-radius: 6px; margin-bottom: 0.5rem; 
                   {% if message.tags == 'success' %}background: #d4edda; color: #155724; border: 1px solid #c3e6cb;
                   {% elif message.tags == 'error' %}background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;
                   {% else %}background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb;{% endif %}">
            <strong>
                {% if message.tags == 'success' %}‚úÖ 
                {% elif message.tags == 'error' %}‚ùå 
                {% else %}‚ÑπÔ∏è{% endif %}
            </strong>
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Debug Info -->
    {% if escola %}
    <div style="background: #e8f4fd; padding: 0.5rem; border-radius: 4px; margin-bottom: 1rem; font-size: 0.9rem;">
        <strong>üìù Editando:</strong> {{ escola.nome }} (ID: {{ escola.id }})
    </div>
    {% else %}
    <div style="background: #f0f8f0; padding: 0.5rem; border-radius: 4px; margin-bottom: 1rem; font-size: 0.9rem;">
        <strong>üÜï Criando nova escola</strong>
    </div>
    {% endif %}

    <div style="background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <form method="post" id="escolaForm" novalidate>
            {% csrf_token %}
            
            <!-- Erros gerais do formul√°rio principal -->
            {% if form.non_field_errors %}
            <div style="background: #f8d7da; color: #721c24; padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem;">
                <strong>‚ùå Erros no formul√°rio:</strong>
                <ul style="margin: 0.5rem 0 0 0; padding-left: 1.5rem;">
                    {% for error in form.non_field_errors %}
                    <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                
                <!-- Informa√ß√µes B√°sicas -->
                <div style="grid-column: span 2;">
                    <h3 style="color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 0.5rem; margin-bottom: 1rem;">üìã Informa√ß√µes B√°sicas</h3>
                </div>

                <!-- Nome -->
                <div style="grid-column: span 2;">
                    <label for="{{ form.nome.id_for_label }}" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">
                        {{ form.nome.label }} *
                    </label>
                    <input type="text" 
                           name="{{ form.nome.name }}" 
                           id="{{ form.nome.id_for_label }}" 
                           value="{{ form.nome.value|default:'' }}" 
                           class="form-field"
                           maxlength="200"
                           required>
                    {% if form.nome.errors %}
                    <div style="color: #e74c3c; font-size: 0.9rem; margin-top: 0.25rem;">
                        {% for error in form.nome.errors %}
                        <div>‚ùå {{ error }}</div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <!-- C√≥digo INEP -->
                <div>
                    <label for="{{ form.codigo_inep.id_for_label }}" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">
                        {{ form.codigo_inep.label }}
                    </label>
                    <input type="text" 
                           name="{{ form.codigo_inep.name }}" 
                           id="{{ form.codigo_inep.id_for_label }}" 
                           value="{{ form.codigo_inep.value|default:'' }}" 
                           class="form-field"
                           maxlength="20">
                    {% if form.codigo_inep.errors %}
                    <div style="color: #e74c3c; font-size: 0.9rem; margin-top: 0.25rem;">
                        {% for error in form.codigo_inep.errors %}
                        <div>‚ùå {{ error }}</div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <!-- Tipo de Escola -->
                <div>
                    <label for="{{ form.tipo_escola.id_for_label }}" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">
                        {{ form.tipo_escola.label }}
                    </label>
                    <select name="{{ form.tipo_escola.name }}" id="{{ form.tipo_escola.id_for_label }}" class="form-field">
                        {% for value, label in form.fields.tipo_escola.choices %}
                            <option value="{{ value }}" {% if form.tipo_escola.value == value %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- N√≠vel de Ensino -->
                <div>
                    <label for="{{ form.nivel_ensino.id_for_label }}" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">
                        {{ form.nivel_ensino.label }}
                    </label>
                    <select name="{{ form.nivel_ensino.name }}" id="{{ form.nivel_ensino.id_for_label }}" class="form-field">
                        {% for value, label in form.fields.nivel_ensino.choices %}
                            <option value="{{ value }}" {% if form.nivel_ensino.value == value %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Quantidade de Alunos -->
                <div>
                    <label for="{{ form.quantidade_alunos.id_for_label }}" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">
                        Quantidade de Alunos
                    </label>
                    <input type="number" 
                           name="{{ form.quantidade_alunos.name }}" 
                           id="{{ form.quantidade_alunos.id_for_label }}" 
                           value="{{ form.quantidade_alunos.value|default:'0' }}" 
                           class="form-field"
                           min="0">
                    {% if form.quantidade_alunos.errors %}
                    <div style="color: #e74c3c; font-size: 0.9rem; margin-top: 0.25rem;">
                        {% for error in form.quantidade_alunos.errors %}
                        <div>‚ùå {{ error }}</div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <!-- Endere√ßo -->
                <div style="grid-column: span 2;">
                    <h3 style="color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 0.5rem; margin-top: 1rem; margin-bottom: 1rem;">üìç Endere√ßo</h3>
                </div>

                <div style="grid-column: span 2;">
                    <label for="{{ form.endereco.id_for_label }}" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">
                        {{ form.endereco.label }} *
                    </label>
                    <textarea name="{{ form.endereco.name }}" 
                              id="{{ form.endereco.id_for_label }}" 
                              class="form-field"
                              rows="3"
                              required>{{ form.endereco.value|default:'' }}</textarea>
                    {% if form.endereco.errors %}
                    <div style="color: #e74c3c; font-size: 0.9rem; margin-top: 0.25rem;">
                        {% for error in form.endereco.errors %}
                        <div>‚ùå {{ error }}</div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <!-- Bairro -->
                <div>
                    <label for="{{ form.bairro.id_for_label }}" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">
                        Bairro
                    </label>
                    <input type="text" 
                           name="{{ form.bairro.name }}" 
                           id="{{ form.bairro.id_for_label }}" 
                           value="{{ form.bairro.value|default:'' }}" 
                           class="form-field"
                           maxlength="100">
                </div>

                <!-- Cidade -->
                <div>
                    <label for="{{ form.cidade.id_for_label }}" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">
                        Cidade
                    </label>
                    <input type="text" 
                           name="{{ form.cidade.name }}" 
                           id="{{ form.cidade.id_for_label }}" 
                           value="{{ form.cidade.value|default:'' }}" 
                           class="form-field"
                           maxlength="100">
                </div>

                <!-- Estado -->
                <div>
                    <label for="{{ form.estado.id_for_label }}" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">
                        Estado
                    </label>
                    <input type="text" 
                           name="{{ form.estado.name }}" 
                           id="{{ form.estado.id_for_label }}" 
                           value="{{ form.estado.value|default:'' }}" 
                           class="form-field"
                           maxlength="2"
                           style="text-transform: uppercase;">
                </div>

                <!-- CEP -->
                <div>
                    <label for="{{ form.cep.id_for_label }}" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">
                        CEP
                    </label>
                    <input type="text" 
                           name="{{ form.cep.name }}" 
                           id="{{ form.cep.id_for_label }}" 
                           value="{{ form.cep.value|default:'' }}" 
                           class="form-field"
                           maxlength="10">
                </div>

                <!-- Contatos Principais -->
                <div style="grid-column: span 2;">
                    <h3 style="color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 0.5rem; margin-top: 1rem; margin-bottom: 1rem;">üìû Contatos Principais</h3>
                </div>

                <!-- Telefone -->
                <div>
                    <label for="{{ form.telefone.id_for_label }}" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">
                        {{ form.telefone.label }}
                    </label>
                    <input type="text" 
                           name="{{ form.telefone.name }}" 
                           id="{{ form.telefone.id_for_label }}" 
                           value="{{ form.telefone.value|default:'' }}" 
                           class="form-field"
                           maxlength="20">
                </div>

                <!-- Email -->
                <div>
                    <label for="{{ form.email.id_for_label }}" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">
                        {{ form.email.label }}
                    </label>
                    <input type="email" 
                           name="{{ form.email.name }}" 
                           id="{{ form.email.id_for_label }}" 
                           value="{{ form.email.value|default:'' }}" 
                           class="form-field"
                           maxlength="254">
                    {% if form.email.errors %}
                    <div style="color: #e74c3c; font-size: 0.9rem; margin-top: 0.25rem;">
                        {% for error in form.email.errors %}
                        <div>‚ùå {{ error }}</div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

                <!-- Diretor -->
                <div>
                    <label for="{{ form.diretor.id_for_label }}" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">
                        Diretor
                    </label>
                    <input type="text" 
                           name="{{ form.diretor.name }}" 
                           id="{{ form.diretor.id_for_label }}" 
                           value="{{ form.diretor.value|default:'' }}" 
                           class="form-field"
                           maxlength="100">
                </div>

                <!-- Respons√°vel para Contato -->
                <div>
                    <label for="{{ form.responsavel_contato.id_for_label }}" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">
                        {{ form.responsavel_contato.label }}
                    </label>
                    <input type="text" 
                           name="{{ form.responsavel_contato.name }}" 
                           id="{{ form.responsavel_contato.id_for_label }}" 
                           value="{{ form.responsavel_contato.value|default:'' }}" 
                           class="form-field"
                           maxlength="100">
                </div>

                <!-- Telefone do Respons√°vel -->
                <div>
                    <label for="{{ form.telefone_responsavel.id_for_label }}" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">
                        Telefone do Respons√°vel
                    </label>
                    <input type="text" 
                           name="{{ form.telefone_responsavel.name }}" 
                           id="{{ form.telefone_responsavel.id_for_label }}" 
                           value="{{ form.telefone_responsavel.value|default:'' }}" 
                           class="form-field"
                           maxlength="20">
                </div>

                <!-- Observa√ß√µes -->
                <div style="grid-column: span 2;">
                    <label for="{{ form.observacoes.id_for_label }}" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">
                        Observa√ß√µes
                    </label>
                    <textarea name="{{ form.observacoes.name }}" 
                              id="{{ form.observacoes.id_for_label }}" 
                              class="form-field"
                              rows="4">{{ form.observacoes.value|default:'' }}</textarea>
                </div>

                <!-- Status -->
                <div style="grid-column: span 2;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; padding: 1rem; background: #f8f9fa; border-radius: 6px; margin-top: 1rem;">
                        <input type="checkbox" 
                               name="{{ form.ativo.name }}" 
                               id="{{ form.ativo.id_for_label }}" 
                               {% if form.ativo.value or not escola %}checked{% endif %}>
                        <label for="{{ form.ativo.id_for_label }}" style="margin: 0; font-weight: bold; cursor: pointer;">
                            {{ form.ativo.label }}
                        </label>
                    </div>
                </div>
            </div>

            <!-- Formset de Contatos Adicionais -->
            {% if formset %}
            <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid #e9ecef;">
                <h3 style="color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 0.5rem; margin-bottom: 1rem;">üì± Contatos Adicionais</h3>
                
                {{ formset.management_form }}
                
                <div id="contatos-formset">
                    {% for form in formset %}
                    <div class="contato-form" style="background: #f8f9fa; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 1rem; align-items: end;">
                            <!-- Tipo -->
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Tipo</label>
                                {{ form.tipo }}
                                {% if form.tipo.errors %}
                                <div style="color: #e74c3c; font-size: 0.8rem;">
                                    {{ form.tipo.errors }}
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Valor -->
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Valor</label>
                                {{ form.valor }}
                                {% if form.valor.errors %}
                                <div style="color: #e74c3c; font-size: 0.8rem;">
                                    {{ form.valor.errors }}
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Observa√ß√£o -->
                            <div>
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Observa√ß√£o</label>
                                {{ form.observacao }}
                            </div>
                            
                            <!-- Principal e Delete -->
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <div style="display: flex; align-items: center; gap: 0.25rem;">
                                    {{ form.principal }}
                                    <label style="margin: 0; font-size: 0.9rem;">Principal</label>
                                </div>
                                
                                {% if formset.can_delete %}
                                <div style="display: flex; align-items: center; gap: 0.25rem;">
                                    {{ form.DELETE }}
                                    <label style="margin: 0; font-size: 0.9rem; color: #e74c3c;">Excluir</label>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Hidden fields -->
                        {{ form.id }}
                    </div>
                    {% endfor %}
                </div>
                
                <button type="button" id="add-contato" class="btn" style="background: #17a2b8; margin-top: 1rem;">
                    ‚ûï Adicionar Outro Contato
                </button>
            </div>
            {% endif %}

            <!-- Bot√µes de A√ß√£o -->
            <div style="display: flex; gap: 1rem; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #e9ecef;">
                <button type="submit" class="btn" style="background: #27ae60;" id="submitBtn">
                    {% if escola %}üíæ Salvar Altera√ß√µes{% else %}‚úÖ Criar Escola{% endif %}
                </button>
                <a href="{% url 'escola:lista_escolas' %}" class="btn" style="background: #6c757d;">‚ùå Cancelar</a>
                
                {% if escola %}
                <a href="{% url 'escola:detalhe_escola' escola.pk %}" class="btn" style="background: #3498db;">
                    üëÅÔ∏è Ver Detalhes
                </a>
                {% endif %}
            </div>
        </form>
    </div>
</div>

<style>
    .form-field {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 1rem;
        box-sizing: border-box;
        transition: all 0.3s ease;
        font-family: inherit;
    }
    
    .form-field:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }
    
    input[type="checkbox"] {
        width: auto;
        transform: scale(1.2);
        margin-right: 0.5rem;
    }
    
    select.form-field {
        background-color: white;
        cursor: pointer;
    }
    
    .btn {
        display: inline-block;
        padding: 0.75rem 1.5rem;
        color: white;
        text-decoration: none;
        border-radius: 6px;
        font-weight: 500;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        text-align: center;
        font-size: 1rem;
    }
    
    .btn:hover:not(:disabled) {
        opacity: 0.9;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    .error-field {
        border-color: #e74c3c !important;
        box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.2) !important;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('escolaForm');
    const submitBtn = document.getElementById('submitBtn');
    
    console.log('üîç Debug: Formul√°rio carregado');
    console.log('üìù Form method:', form.method);
    
    // Valida√ß√£o do formul√°rio
    form.addEventListener('submit', function(e) {
        console.log('‚úÖ Formul√°rio sendo submetido...');
        
        let isValid = true;
        const requiredFields = [
            { field: document.getElementById('{{ form.nome.id_for_label }}'), name: 'Nome da Escola' },
            { field: document.getElementById('{{ form.endereco.id_for_label }}'), name: 'Endere√ßo' }
        ];
        
        requiredFields.forEach(({ field, name }) => {
            if (field && !field.value.trim()) {
                field.classList.add('error-field');
                isValid = false;
                console.log(`‚ùå Campo obrigat√≥rio vazio: ${name}`);
                
                if (!isValid) {
                    field.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    field.focus();
                }
            } else if (field) {
                field.classList.remove('error-field');
            }
        });
        
        if (!isValid) {
            e.preventDefault();
            alert('‚ùå Por favor, preencha todos os campos obrigat√≥rios marcados com *');
            return;
        }
        
        submitBtn.innerHTML = '‚è≥ Salvando...';
        submitBtn.disabled = true;
        console.log('üì§ Formul√°rio v√°lido, enviando para o servidor...');
    });
    
    // Remover estilo de erro quando o usu√°rio come√ßar a digitar
    const fields = form.querySelectorAll('.form-field');
    fields.forEach(field => {
        field.addEventListener('input', function() {
            this.classList.remove('error-field');
        });
    });
    
    // Funcionalidade para adicionar mais contatos (formset)
    const addButton = document.getElementById('add-contato');
    if (addButton) {
        addButton.addEventListener('click', function() {
            const totalForms = document.getElementById('id_contatoescola_set-TOTAL_FORMS');
            const currentCount = parseInt(totalForms.value);
            const formsetContainer = document.getElementById('contatos-formset');
            
            // Clone do template (√∫ltimo form)
            const lastForm = formsetContainer.querySelector('.contato-form:last-child');
            const newForm = lastForm.cloneNode(true);
            
            // Atualizar √≠ndices
            const regex = new RegExp('-' + (currentCount - 1) + '-', 'g');
            newForm.innerHTML = newForm.innerHTML.replace(regex, '-' + currentCount + '-');
            
            // Limpar valores
            newForm.querySelectorAll('input, select').forEach(field => {
                if (field.type !== 'checkbox' && field.type !== 'hidden') {
                    field.value = '';
                }
                if (field.type === 'checkbox') {
                    field.checked = false;
                }
            });
            
            // Adicionar ao container
            formsetContainer.appendChild(newForm);
            
            // Atualizar contador
            totalForms.value = currentCount + 1;
        });
    }
});
</script>
{% endblock %}